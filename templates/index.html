<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Crop Advisory Portal</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
.container { max-width:1100px; margin:auto; background:#fff; padding:25px; border-radius:8px; }
h1 { color:#121212; text-align:center; margin-bottom:50px;font-family: 'Copperplate' }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; align-items:start; }
img { width:100%; border-radius:5px; height:250px; object-fit:cover; }

label { font-weight:bold; margin-top:10px; display:block; }
input, select, button { width:100%; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #ccc; }
button { background:#2e7d32; color:#fff; border:none; cursor:pointer; font-size:16px; }
button:hover { background:#27664b; }

.results-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
.card { background:#f4f6f8; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.card h3 { color:#080808; margin-bottom:10px; }
.table-wrapper { overflow-x:auto; }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#dcedc8; }
.orange-card { background:#ffe0b2; }
canvas { max-height:250px; margin-top:15px; }
</style>
</head>
<body>
<div class="container">
<h1>Crop Advisory Portal</h1>
<div class="grid">
  <div>
    <img id="cropImg" src="/static/images/bajra.jpg">
  </div>
  <div>
    <label>Crop</label>
    <select id="crop">
      {% for c in crops %}
      <option>{{c}}</option>
      {% endfor %}
    </select>

    <label>Select State</label>
    <select id="state">
      <option value="">All States</option>
      {% for s in states %}
      <option>{{s}}</option>
      {% endfor %}
    </select>

    <label>Total Cost of Cultivation (₹)</label>
    <input id="cost" type="number" placeholder="e.g. 18000">

    <label>Total Quantity (kg)</label>
    <input id="quantity" type="number" placeholder="e.g. 1000">

    <label>Desired Profit (%)</label>
    <input id="profit" type="number" placeholder="e.g. 20">

    <button onclick="calculate()">Get Advisory</button>
  </div>
</div>

<div class="results-container">
  <div class="card">
    <h3>Cultivation Info</h3>
    <p>Total Cost: ₹<b id="totalCost">-</b></p>
    <p>Cost per kg: ₹<b id="costPerKg">-</b></p>
    <p>Total Quantity: <b id="totalQty">-</b> kg</p>
    <p>Total Revenue: ₹<b id="totalRevenue">-</b></p>
  </div>

  <div class="card">
    <h3>Pricing Info</h3>
    <p>Required Price: ₹<b id="requiredPrice">-</b></p>
    <p>MSP: ₹<b id="msp">-</b></p>
    <p>Market Price (Selected State): ₹<b id="market">-</b></p>
  </div>

  <div class="card orange-card">
    <h3>Selected State Revenue</h3>
    <p>Revenue: <b id="selectedRevenue">-</b></p>
    <p id="advice"></p>
  </div>

  <div class="card">
    <h3>Top 3 States to Sell</h3>
    <div class="table-wrapper">
      <table>
        <thead><tr><th>State</th><th>Revenue (₹)</th></tr></thead>
        <tbody id="topStates"></tbody>
      </table>
    </div>
  </div>
</div>

<h3>State-wise Potential Revenue (₹)</h3>
<canvas id="chart"></canvas>

<script>
const images = {{ images|tojson }};
let chart;

document.getElementById("crop").addEventListener("change", function(){
    const crop = this.value;
    document.getElementById("cropImg").src = "/static/images/" + images[crop];
});

function calculate(){
  const crop = document.getElementById("crop").value;
  const cost = document.getElementById("cost").value;
  const quantity = document.getElementById("quantity").value;
  const profit = document.getElementById("profit").value;
  const state = document.getElementById("state").value;

  if(!crop || !cost || !quantity || !profit){
    alert("Please fill all fields!");
    return;
  }

  fetch("/calculate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({crop,cost,quantity,profit,state})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.error){alert(data.error);return;}

    // Cultivation Info
    document.getElementById("totalCost").innerText = cost;
    document.getElementById("costPerKg").innerText = data.cost_per_kg;
    document.getElementById("totalQty").innerText = quantity;
    document.getElementById("totalRevenue").innerText = data.total_revenue;

    // Pricing Info
    document.getElementById("requiredPrice").innerText = data.required_price;
    document.getElementById("msp").innerText = data.msp;
    document.getElementById("market").innerText = data.market ? data.market : "-";

    // Selected State Revenue & Advice
    document.getElementById("selectedRevenue").innerText = 
        data.selected_state_revenue ? data.selected_state_revenue : "Revenue not available for this state.";
    document.getElementById("advice").innerText = data.advice;

    // Top States Table
    const topStatesEl = document.getElementById("topStates");
    topStatesEl.innerHTML="";
    data.top_states.forEach(s=>{
      const row = document.createElement("tr");
      row.innerHTML = `<td>${s[0]}</td><td>₹${s[1]}</td>`;
      topStatesEl.appendChild(row);
    });

    // State-wise chart
    const labels = Object.keys(data.state_revenues);
    const revenues = Object.values(data.state_revenues);
    const bgColors = labels.map(l=> l===state ? "#ff9800" : "#2e7d32");

    if(chart) chart.destroy();
    const ctx = document.getElementById("chart").getContext("2d");
    chart = new Chart(ctx,{
      type:"bar",
      data:{
        labels:labels,
        datasets:[{label:"Revenue (₹)", data:revenues, backgroundColor:bgColors}]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true, title:{display:true,text:"Revenue (₹)"}}, x:{title:{display:true,text:"States"}}}
      }
    });
  })
  .catch(err=>alert("Error: "+err));
}
</script>
</div>
</body>
</html>
